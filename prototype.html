
<html>
<head>
  <title>A D3 map</title>
  <script src='https://d3js.org/d3.v5.min.js'></script>
  <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <script src='data/schland.geo.js'></script>
  <script src="data/extracted_institution_data_geocoded.geo.js"></script>
  
  <style>
	  
	  body {
		  font-family: Trebuchet MS,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
		  color: #666;
	  }
  .map {
		box-shadow: 0px 0px 5px #ccc;
	  }
	  
	.institute-circle {
		opacity: 0.5;
	}
	
	.institute-circle:hover {
		opacity: 1;
		cursor:pointer;
	}
	
	.info {
		width: 600px;
		height: 600px;
				box-shadow: 0px 0px 5px #ccc;

		// position: fixed;
		top: 50px;
		left: 50px;
		
		margin-left: 900px;
		margin-bottom: -600px;
		background-color: #fff;
		z-index:1000;
		
		
		display:block;
		/*display:none;*/
		
		padding: 10px 20px;

	}
	
	.institute-name {
		display: block;
		margin: 0;
		font-size: 20px;
	}
  </style>
</head>
<body>
	
	<div class="info">
		<h1 class="institute-name">Institute Name</h1>
	</div>
  <script>
	  


var width = 800,
    height = 800;

var map = d3.select('body')
  .append('svg')
  .attr('width', width)
  .attr('height', height)
  .attr('class','map');
  

var deutschland = map.append('g');

var projection = d3.geoAlbers()
  .scale(5600)
  .center([11.0, 50.8])
    .rotate([0, 0])
  .translate([width/2, height/2]);

var geoPath = d3.geoPath()
    .projection(projection)
    .pointRadius([5]);

deutschland.selectAll('path')
  .data(schland.features)
  .enter()
  .append('path')
  .attr('fill', '#fff')
  .attr('stroke', '#ccc')
  .attr('d', geoPath)
  .attr('radius','100');

// problem hue range not good for viz, better brightness range
var color = d3.scaleLinear()
    .domain([0, 1])
    .range(["blue", "red"]);

color(20); // "#9a3439"
color(50); // "#7b5167"

var radius = d3.scaleLinear()
	.domain([1,2922])
	.range([3,10])
	 
var institute = map.append('g');
		
var topResearchers = d3.csv("data/top_researchers_by_projects.csv").then(function(data) {
  console.log(data[0]);
});		
		
			
institute.selectAll('circle')
		    .data(institute_data.features.filter(function(d){return d.properties.total_projects_count>5;}))
  .enter()
  .append('circle')
  .attr('r', function(d,i) {
	  return radius(d.properties.total_projects_count);
  })
  .attr('cx',function(d) { return projection(d.geometry.coordinates)[0]})
  .attr('cy',function(d) { return projection(d.geometry.coordinates)[1]})
  .attr('fill', function(d,i) { 
	   return color(d.properties.institution_gender_index); 
	})
  .attr('stroke-width', 0)
  //.attr('d', geoPath)
  .on('click', function(institut){
	  console.log(institut.properties.name + ":" + institut.properties.institution_gender_index);
	  d3.select('.institute-name').text(institut.properties.name);
	  
	  var instituteResearchers = topResearchers.filter(function(d){return d.institution_id==institut.properties.id;})
	  
	  // create barchart
	
	  var svg = d3.select('.info')
	  .append('svg')
		margin = {
			top: 20,
			right: 20,
			bottom: 30,
			left: 50
		},
		width = +svg.attr("width") - margin.left - margin.right,
		height = +svg.attr("height") - margin.top - margin.bottom,
		g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
		var x = d3.scaleBand()
		.rangeRound([0, width])
		.padding(0.1)
		.domain(instituteResearchers.map(function (d) {
			return d.person_id;
		}));
		var y = d3.scaleLinear()
		.rangeRound([height, 0]);
		.domain([0,, d3.max(data, function (d) {
				return Number(d.project_count);
			})]);
		
		/*
		
		g.append("g")
	.attr("transform", "translate(0," + height + ")")
	.call(d3.axisBottom(x))

	g.append("g")
	.call(d3.axisLeft(y))
	.append("text")
	.attr("fill", "#000")
	.attr("transform", "rotate(-90)")
	.attr("y", 6)
	.attr("dy", "0.71em")
	.attr("text-anchor", "end")
	.text("Speed");

	g.selectAll(".bar")
	.data(data)
	.enter().append("rect")
	.attr("class", "bar")
	.attr("x", function (d) {
		return x(d.Run);
	})
	.attr("y", function (d) {
		return y(Number(d.Speed));
	})
	.attr("width", x.bandwidth())
	.attr("height", function (d) {
		return height - y(Number(d.Speed));
	});
		
		*/

var y = d3.scaleLinear()
	.rangeRound([height, 0]);
	  
  })
  .attr('class','institute-circle');
  
var zoom = d3.zoom();

map.call(d3.zoom()
  .extent([[0, 0], [width, height]])
  .scaleExtent([1, 50])
  .on("zoom", zoomed));

  function zoomed() {
    deutschland.attr("transform", d3.event.transform);
    institute.attr("transform", d3.event.transform);
    
    var scaleFactor = d3.event.transform.k;
	
	institute.selectAll('circle')
	.attr('r', function(d,i) {
	  return radius(d.properties.total_projects_count)/(scaleFactor*0.8);
  })
 // .attr('stroke-width',1/scaleFactor);

}

  
  </script>
</body>
</html>
