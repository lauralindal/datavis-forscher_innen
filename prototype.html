<html>

<head>
  <title>A D3 map</title>

  <meta charset="UTF-8">

  <script src='lib/d3.v5.min.js'></script>
  <script src="lib/jquery-3.4.1.min.js"></script>
  <script src='lib/jquery.waypoints.min.js'></script>

  <script src='data/schland.geo.js'></script>
  <script src="data/extracted_institution_data_geocoded.geo.js"></script>

  <style>
    *,
    *:before,
    *:after {
      box-sizing: border-box;
    }

    body {
      font-family: Trebuchet MS, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      color: #666;
    }

    .fixed-header {
      width: 50vw;
      padding: 20px;
      margin: 0px auto;
      position: fixed;
      font-style: bold;
      font-size: 20px;
    }

    .map {
      box-shadow: 0px 0px 5px #ccc;
    }

    .institute-circle {
      /*opacity: 0.5;*/
    }

    .institute-circle:hover {
      opacity: 1;
      cursor: pointer;
    }

    .institute-name {
      display: block;
      margin: 0;
      font-size: 20px;
      line-height: 2.4;
    }

    .institute-gi {
    	width: 50px;
			height: 50px;
			border-radius: 50%;
			text-align: center;
			padding-top: 13px;
			color:
			#fff;
			font-weight: bold;
			float: left;

			margin-right: 10px;
			font-size: 20px;
    }

    .chart {
      position: fixed;
      height: 100vh;
      width: 45vw;
      padding: 20px;
      margin-top: 140px;
    }

    .text {
      margin-top: 100px;
      float: right;
      width: 50vw;
      padding: 20px;
    }

    .info {
      box-shadow: 0px 0px 5px #ccc;
      margin-top: 30px;
      background-color: #fff;
      z-index: 1000;
      display: none;
      padding: 10px 20px;
    }

    .person-name {
      display: block;
      margin: 0;
      font-size: 17px;
      margin-bottom: 15px;
    }

    .tooltip {
    	display: none;
    	position: absolute;
    	background-color: #fff;
    	z-index: 9999;
    	font-size: 14px;
    	padding: 10px;
    	text-transform: capitalize;
    	      box-shadow: 0px 0px 5px #666;

    }

    .welcome-pic {
      background-image: url('img/welcome.jpeg');
      background-repeat: no-repeat;
      background-size: contain;
      width: 100%;
      height: 100%;
    }

    .overall_gender_data {
      background-image: url('img/gender_ratio_in_dataset.png');
      background-repeat: no-repeat;
      background-size: contain;
      width: 100%;
      height: 100%;
    }

    .prof_gender_data {
      background-image: url('img/prof_gender_data.png');
      background-repeat: no-repeat;
      background-size: contain;
      width: 100%;
      height: 100%;
    }

    .project_gender_index {
      background-image: url('img/project_gender_index_hist.png');
      background-repeat: no-repeat;
      background-size: contain;
      width: 100%;
      height: 100%;
    }

    .scroll-info-text {
      font-size: 25px;

      height: 100vh;
    }

    .tick {
    	text-transform: capitalize;
    	font-size: 12px;
    }

    .xlabel {
    	font-size: 12px;
    	font-weight: normal;
    	color:#666;
    }

    blockquote {
      font-style: italic;
    }

    .institute-labels {
    	font-size: 12px;
    }

    .institute-labels:hover {
    	cursor:pointer;
    	font-weight: bold;
    }
  </style>

</head>

<body>

  <div class="fixed-header">
    <h1>Gendered collaboration in German research</h1>
  </div>

  <div class="chart">
  </div>

  <div class="text">
    <div id="preinfo" class="pre-info scroll-info-text">
      <div class="">
        <p>
          <blockquote>"There is now abundant data that diversity is essential to scientific excellence, with experiments showing that diverse teams have cognitive diversity that allows them to outperform homogeneous teams." <a
              href="https://fas.columbia.edu/files/fas/content/Columbia-ArtsandSciences-PPC-Equity-Reports-2018.pdf">(Columbia University 2018)</a></blockquote>
        </p>
        <p>Unfortunately, <a href="https://www.equityinstem.org/networks-metaanalysis/">research shows</a> that people tend to form their networks with people who are similar to them, which can hinder diversity in fields that have traditionally been
          shaped by networks of white men, such as academia.</p>
        <p><strong>How diverse are German research projects regarding the gender ratio of their teams?</strong></p>
        <p><strong>How gender diverse are individual researchers' collaborations?</strong></p>
      </div>
    </div>

    <div id="overall_gender_data" class="scrollable-1 scroll-info-text">
      <p>Let's find out from data by one of the largest German institutions to fund research projects: <a href="https://gepris.dfg.de/gepris/OCTOPUS?language=en">Deutsche Forschungsgemeinschaft</a>.</p>
      <p>They do not provide information on the gender of their research, so with <a href="https://ideas.repec.org/c/wip/eccode/10.html">a little help</a>, we had to infer a gender based on the researcher's first name.</p>
      <p><strong>This is the gender distribution of all researchers funded by the DFG.</strong></p>
    </div>

    <div id="prof_gender_data" class="scrollable-1 scroll-info-text">
      <p>To stay critical of this data and validate our inference, we used a subset of the data that contains only professors.</p>
      <p>Since the title "Professor" / "Professorin" has a gendered connotation in German, we could compare the gendered title to our inferred gender.</p>
      <p class="note">Please also note that we were unable to infer outside of the gender binary due to the lack of such a dataset.</p>
      <p>Mistakes are represented in gray and contain three error classes: a mismatch between title and inferred gender, a gender could not be assigned or the first name was not recognized.</p>
      <p><strong>This is the ratio of correct gender inference for the subset of professors.</strong></p>
    </div>

    <div id="project_gender_index" class="scrollable-1 scroll-info-text">
      <p>Looking at each funded project with more than one person, we can now calculate the gender ratio per project.</p>
      <p>Thus, the project gender index indicates the gender ratio in a project, where 0 means there are only men and 1 means there are only women.</p>
      <p>In detail, 10488 (67%) collaborative projects funded by the DFG involve only men, whereas 667 (4%) involve only women.</p>
      <p><strong>This histogram shows the distribution of the project gender index.</strong></p>
    </div>

    <div id="map" class="scrollable-1 scroll-info-text">
      <p>You can now look at individual insitutions and their gender index, based on the researchers associated with them.</p>
      <div class="info">
      </div>
            	<div class="tooltip"></div>

    </div>

    <div id="sort_values" class="scrollable-1 scroll-info-text">
      <p>The top 30 Institutions are deep blue...</p>
      <div class="info">
      </div>
            	<div class="tooltip"></div>

    </div>
  </div>

  <script>
    var backgroundColor = "#ccc";

    // problem hue range not good for viz, better brightness range
    var color = d3.scaleLinear()
      .domain([0, 1])
      .range(["DodgerBlue", "DeepPink"]);

    var radius = d3.scaleLinear()
      .domain([1, 2922])
      .rangeRound([3, 10]) // instead of range, to avoid blurry

    var chartPadding = 20;

    // load researcher data
    var topResearchers = d3.csv("data/top_researchers_by_projects_detailed.csv").then(function(data) {
      topResearchers = data;
    });

    var allResearchersGender = d3.csv("data/gender_ratio_in_dataset.csv").then(function(data) {
      allResearchersGender = data;
    });

    // load person data (person_id, name, first_name, gender)
    var personData = d3.csv("data/reduced_data_person.csv").then(function(data) {
      personData = data;
    });

    institute_data.features = institute_data.features.filter(function(d) {
            return d.geometry.coordinates[0];
    })

    // get the dynamic dims of chart
    var dim = d3.select('.chart').node().getBoundingClientRect();
    var width = dim.width - 2 * chartPadding,
      height = dim.height - 2 * chartPadding;

    function round2dezimals(float) {
    	return (Math.round(float * 100) / 100)
    }

		var currentMousePos = { x: -1, y: -1 };

    var showWelcome = function() {
      // clear chart
      $('.chart').fadeOut(100, function() {
        d3.select('.chart').selectAll("*").remove();
        d3.select('.chart')
          .append('div')
          .attr('class', 'welcome-pic');
        $('.chart').fadeIn(100)
      });
    };

    var showOverallGenderData = function() {
      // clear chart
      $('.chart').fadeOut(100, function() {
        d3.select('.chart').selectAll("*").remove();
        d3.select('.chart')
          .append('div')
          .attr('class', 'overall_gender_data');
        $('.chart').fadeIn(100)
      });
    };

    var showProfGenderValidation = function() {
      // clear chart
      $('.chart').fadeOut(100, function() {
        d3.select('.chart').selectAll("*").remove();
        d3.select('.chart')
          .append('div')
          .attr('class', 'prof_gender_data');
        $('.chart').fadeIn(100)
      });
    };

    var showProjectGenderIndex = function() {
      // clear chart
      $('.chart').fadeOut(100, function() {
        d3.select('.chart').selectAll("*").remove();
        d3.select('.chart')
          .append('div')
          .attr('class', 'project_gender_index');
        $('.chart').fadeIn(100)
      });
    };
		
		var map;
	  var zoom = d3.zoom();
	  var deutschland;
	  var institute;
    var showMap = function() {

      // clear chart
      $('.chart').fadeOut(100, function() {

        // clear chart
        d3.select('.chart').selectAll("*").remove();

        map = d3.select('.chart')
          .append('svg')
          .attr('width', width)
          .attr('height', height)
          .attr('class', 'map')
          .style('background-color', backgroundColor);

        deutschland = map.append('g');

        var projection = d3.geoAlbers()
          .scale(4000)
          .center([11.0, 50.8])
          .rotate([0, 0])
          .translate([width / 2, height / 2]);

        var geoPath = d3.geoPath()
          .projection(projection)
          .pointRadius([5]);

        deutschland.selectAll('path')
          .data(schland.features)
          .enter()
          .append('path')
                  	.attr("class","schland")

          .attr('fill', '#888')
          .attr('stroke', '#000')
          .attr('d', geoPath);

        // show barchart of institute, top10 researchers
        function clickMapCircle(institut) {

          // clear old data
          var info = d3.selectAll('.info');
          info.style('display', 'block').selectAll("*").remove();
          console.log(institut.properties.name + ":" + institut.properties.institution_gender_index);

					info.append('div')
          	.attr('class', 'institute-gi')
          	.style('background-color', color(institut.properties.institution_gender_index))
          	.text(round2dezimals(institut.properties.institution_gender_index))
          	;
          info.append('div')
          	.attr('class', 'institute-name')
          	.text(institut.properties.name);
          
          // get researchers from this institute, and only get those with gender index defined
          var instituteResearchers = topResearchers.filter(function(d) {
            return d.institution_id == institut.properties.institution_id && d.person_gender_index != "";
          });

          // sort by project count
          instituteResearchers.sort((a, b) => d3.descending(Number(a.project_count), Number(b.project_count))).reverse();

          //
          console.log(instituteResearchers);

          // create barchart
          var svg = info
            .style('background-color', backgroundColor)
            .append('svg')
            .attr('width', dim.width)
            .attr('height', (instituteResearchers.length+1)*38);

          // margins for the rectangles
          var margin = {
              top: 20,
              right: 20,
              bottom: 60,
              left: 280
            },
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            var x = d3.scaleLinear()
            .rangeRound([0, width])
            .domain([0, d3.max(instituteResearchers, function(d) {
              return Number(d.project_count);
            })])
            .nice()
            ;

            var y = d3.scaleBand()
            .rangeRound([height, 0])
            .domain(instituteResearchers.map(function(d) {
              return d.name;
            }))
            .paddingInner(0.3);

            console.log(instituteResearchers.map(function(d) {
              return d.name;
            }))

					// create the x axis
          g.append("g")
            .call(
            	d3.axisBottom(x)
            	)
            .attr("transform", "translate(0," + (height + 6) + ")");

                    // create the y axis
          g.append("g")
            .call(
            	d3.axisLeft(y).tickSize(6)
            	).attr("stroke-width",0)
            //.attr("y", 6)
            .append("text")

            // create the bars
          g.selectAll(".bar")
            .data(instituteResearchers)
            .enter()
            .append("rect")
            .attr("fill", function(d) {
              return color(d.person_gender_index);
            })
            .attr("x", function(d) {
              return 0;
            })
            .attr("y", function(d) {
              return y(d.name);
            })
            .attr("width", function(d) {
              return x(Number(d.project_count));
            })
            .attr("height", y.bandwidth())
            .style("cursor", "pointer")
            .on('mouseover',function(d){
            	var gender = (d.gender == "F" ? "Female" : "Male");

            	$(".tooltip").show()
            	.html('<div><div class="institute-gi" style="background-color: '+color(d.person_gender_index)+'">' + round2dezimals(d.person_gender_index) + '</div><div class="person-name">'+d.name+'</div></div><div style="claer:both"><b>Project Count:</b> ' + d.project_count + '<br><b>Gender:</b> ' + gender + '</di>')
            	.css({ 'top': currentMousePos.y+'px', 'left': currentMousePos.x+'px'});
            	
                     	
            }).on('mouseout',function(d){

            	$(".tooltip").hide()
            	
            });

           svg.append("text")
				    .attr("class", "xlabel")
				    .attr("text-anchor", "end")
				    .attr("x", width + margin.left)
				    .attr("y", height + margin.top)
				    .text("Project Count");
        }

        institute = map.append('g');
        institute.selectAll('circle')
        	.attr("class","institute")
          .data(institute_data.features.filter(function(d) {
            return d.properties.total_projects_count > 5;
          }))
          .enter()
          .append('circle')
          .attr('r', function(d, i) {
            return radius(d.properties.total_projects_count);
          })
          .attr('cx', function(d) {
            return projection(d.geometry.coordinates)[0]
          })
          .attr('cy', function(d) {
            return projection(d.geometry.coordinates)[1]
          })
          .attr('fill', function(d, i) {
            return color(d.properties.institution_gender_index);
          })
          .attr('stroke-width', 0)
          .attr('class', 'institute-circle')
          .on('click', clickMapCircle)
          .append("svg:title") // TITLE APPENDED HERE
          .text(function(institut) {
            return institut.properties.name + "\n" + (Math.round(institut.properties.institution_gender_index * 100) / 100);
          });

        map.call(d3.zoom()
          .extent([
            [0, 0],
            [dim.width, dim.height]
          ])
          .scaleExtent([1, 50])
          .on("zoom", zoomed));

        function zoomed() {
          deutschland.attr("transform", d3.event.transform);
          institute.attr("transform", d3.event.transform);

          var scaleFactor = d3.event.transform.k;

          institute.selectAll('circle')
            .attr('r', function(d, i) {
              return radius(d.properties.total_projects_count) / (scaleFactor * 0.8);
            })
        }

        $('.chart').fadeIn(100)
      });
    };

    function resetZoom(){
    	    deutschland.attr("transform", d3.zoomIdentity);
          institute.attr("transform", d3.zoomIdentity);


          institute.selectAll('circle')
            .attr('r', function(d, i) {
              return radius(d.properties.total_projects_count);
            })
    }

    var showSorted = function() {
    	$('.schland').fadeOut();
			resetZoom();
    	
    	var institute = institute_data.features.filter(function(d) {
            return d.properties.total_projects_count > 5;
          })

    	institute.sort((a, b) => d3.descending(Number(a.properties.total_projects_count), Number(b.properties.total_projects_count)));

    	var topUnis = institute.slice(0,40)
    	console.log(topUnis)

    	var y = d3.scaleBand()
        .rangeRound([0,dim.height-50])
        .domain(topUnis.map(function(d) {
          return d.properties.name;
        }))
        .paddingInner(0.5);


     	map.style('background-color','#fff');


     	map.selectAll('g').call(zoom.transform, d3.zoomIdentity);

    	var circles = d3.selectAll('.institute-circle')
    	.transition()
    	.duration(2000)
    	.attr("cx",function(d,i){
    				//console.log(d);
            //return 1;

            if(topUnis.some(e => d.properties.name == e.properties.name)) {
    					return 30;//y(d.properties.name);
    				}
            else {
            	return -999;
            }

      })
      	.attr("cy",function(d,i){
    				//console.log(d);

    				if(topUnis.some(e => d.properties.name == e.properties.name)) {
    					return y(d.properties.name)+25;
    				}
            else { return 100
            }

      });

      	  var t = map.append('g');
        	t.selectAll('g')
          .data(topUnis)
          .enter()
          .append('text')
          .attr("class","institute-labels")
					.transition()
    			.duration(0)
    			.delay(1500)
          .attr('x', function(d, i) {
            return 50;
          })
          .attr('y', function(d, i) {
            return y(d.properties.name)+30;
          })
          .text(function(d, i) {
            return d.properties.name;
          })
      
    };

    // scroll handling

    //waypoints scroll constructor
    function scroll(selector, offset, func1, func2) {
      return new Waypoint({
        element: document.getElementById(selector),
        handler: function(direction) {
          direction == 'down' ? func1() : func2();
        },
        offset: offset
      });
    };

    showWelcome();

    //triger these functions on page scroll
    //scroll('preinfo', '50%', showWelcome, showOverallGenderData);
    //scroll('overall_gender_data', '50%', function(){console.log("test1")}, function(){console.log("test2")});

    scroll('overall_gender_data', '75%', showOverallGenderData, showWelcome);
    scroll('prof_gender_data', '75%', showProfGenderValidation, showOverallGenderData);
    scroll('project_gender_index', '75%', showProjectGenderIndex, showProfGenderValidation);
    scroll('map', '75%', showMap, showProjectGenderIndex);
    scroll('sort_values', '75%', showSorted, showMap);

    //new scroll('div4', '75%', divide, grid);
    //new scroll('div6', '75%', barChart, divide);


    $(document).mousemove(function(event) {
        currentMousePos.x = event.pageX;
        currentMousePos.y = event.pageY;
    });
  </script>
</body>

</html>
