<html>

<head>
  <title>A D3 map</title>

  <meta charset="UTF-8">

  <script src='https://d3js.org/d3.v5.min.js'></script>
  <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <script src='data/schland.geo.js'></script>
  <script src="data/extracted_institution_data_geocoded.geo.js"></script>

  <style>
    body {
      font-family: Trebuchet MS, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      color: #666;
    }

    .pre-info {
      margin-left: 20px;
      margin-top: 30px;
      background-color: #fff;
    }

    .scrollable-1 {
      margin-left: 20px;
      margin-top: 30px;
      background-color: #fff;
    }

    .map {
      box-shadow: 0px 0px 5px #ccc;
      margin-top: 20px;
      margin-left: 20px;
    }

    .institute-circle {
      /*opacity: 0.5;*/
    }

    .institute-circle:hover {
      opacity: 1;
      cursor: pointer;
    }

    .info {
      width: 600px;
      height: 600px;
      box-shadow: 0px 0px 5px #ccc;
      margin-left: 900px;
      margin-bottom: -640px;
      margin-top: 30px;
      background-color: #fff;
      z-index: 1000;
      display: none;
      padding: 10px 20px;

    }

    .institute-name {
      display: block;
      margin: 0;
      font-size: 20px;
    }
  </style>
</head>

<body>

  <div class="pre-info">
    <h1>Gendered collaboration in German research</h1>
    <h2>"There is now abundant data that diversity is essential to scientific excellence, with experiments showing that diverse teams have cognitive diversity that allows them to outperform homogeneous teams." <a href="https://fas.columbia.edu/files/fas/content/Columbia-ArtsandSciences-PPC-Equity-Reports-2018.pdf">(Columbia University 2018)</a></h2>
    <h2>Unfortunately, <a href="https://www.equityinstem.org/networks-metaanalysis/">research shows</a> that people tend to form their networks with people who are similar to them, which can hinder diversity in fields that have traditionally been shaped by white male networks, such as academia.</h2>
    <h2>So, how diverse are German research projects regarding the gender ratios of their teams?</h2>
    <h2>And how diverse are individual researchers' collaborations?</h2>
    <h2></h2>
  </div>

  <div class="scrollable-1">
    <h2>We're looking into one of the largest German institutions to fund research projects.</h2>
    <h2>The overall gender ratio of people who receive funding is already... unequal.</h2>
    <h2>TODO bar chart overall gender ratio</h2>
  </div>

  <div class="scrollable-1">
    <h2>Let's look at collaborations more specifically. This will reduce our dataset...</h2>
    <h2>TODO pie chart (?) for collabs and single person projects?</h2>
  </div>

  <div class="scrollable-1">
    <h2>If we now calculate the gender ratio within each project, we will receive a distribution like so.</h2>
    <h2>TODO histogram for project_gender_index in 10 bars ? </h2>
  </div>

  <div class="info">
  </div>

  <script>
    var backgroundColor = "#ccc";

    // problem hue range not good for viz, better brightness range
    var color = d3.scaleLinear()
      .domain([0, 1])
      .range(["blue", "red"]);

    var radius = d3.scaleLinear()
      .domain([1, 2922])
      .rangeRound([3, 10]) // instead of range, to avoid blurry


    // load researcher data
    var topResearchers = d3.csv("data/top_researchers_by_projects.csv").then(function(data) {
      topResearchers = data;
    });

    var width = 800,
      height = 800;

    var map = d3.select('body')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .attr('class', 'map')
      .style('background-color', backgroundColor);

    var deutschland = map.append('g');

    var projection = d3.geoAlbers()
      .scale(5600)
      .center([11.0, 50.8])
      .rotate([0, 0])
      .translate([width / 2, height / 2]);

    var geoPath = d3.geoPath()
      .projection(projection)
      .pointRadius([5]);

    deutschland.selectAll('path')
      .data(schland.features)
      .enter()
      .append('path')
      .attr('fill', '#888')
      .attr('stroke', '#000')
      .attr('d', geoPath);


    function showInstituteData(institut) {
      // clear old data
      d3.select('.info').style('display', 'block').selectAll("*").remove();
      console.log(institut.properties.name + ":" + institut.properties.institution_gender_index);

      d3.select('.info').append('h1').attr('class', 'institute-name').text(institut.properties.name);

      // get researchers from this institute, and only get those with gender index defined
      var instituteResearchers = topResearchers.filter(function(d) {
        return d.institution_id == institut.properties.institution_id && d.person_gender_index != "";
      });

      // sort by poroject count
      instituteResearchers.sort((a, b) => d3.descending(Number(a.project_count), Number(b.project_count)));

      // create barchart

      var svg = d3.select('.info')
        .style('background-color', backgroundColor)
        .append('svg')
        .attr('width', 500)
        .attr('height', 500);

      // margins for the rectangles
      var margin = {
          top: 20,
          right: 20,
          bottom: 30,
          left: 50
        },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var x = d3.scaleBand() // scaleband for barcharts
        .rangeRound([0, width])
        .padding(0.1)
        .domain(instituteResearchers.map(function(d) {
          return d.person_id;
        }));

      var y = d3.scaleLinear()
        .rangeRound([height, 0])
        .domain([0, d3.max(instituteResearchers, function(d) {
          return Number(d.project_count);
        })]);

      // create the x axis
      g.append("g")
        .call(d3.axisBottom(x))
        .attr("transform", "translate(0," + height + ")")

      // create the y axis
      g.append("g")
        .call(d3.axisLeft(y))
        .append("text")
        .attr("fill", "#000")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "-40")
        .attr("text-anchor", "end")
        .text("Anzahl Projekte");

      // create the bars
      g.selectAll(".bar")
        .data(instituteResearchers)
        .enter().append("rect")
        .attr("fill", function(d) {
          console.log(d);
          return color(d.person_gender_index);
        })
        .attr("x", function(d) {
          return x(d.person_id);
        })
        .attr("y", function(d) {
          return y(Number(d.project_count));
        })
        .attr("width", x.bandwidth())
        .attr("height", function(d) {
          return height - y(Number(d.project_count));
        })
        .append("svg:title") // TITLE APPENDED HERE
        .text(function(person) {
          return person.name + "\n" + (Math.round(person.person_gender_index * 100) / 100);
        });;
    }

    var institute = map.append('g');
    institute.selectAll('circle')
      .data(institute_data.features.filter(function(d) {
        return d.properties.total_projects_count > 5;
      }))
      .enter()
      .append('circle')
      .attr('r', function(d, i) {
        return radius(d.properties.total_projects_count);
      })
      .attr('cx', function(d) {
        return projection(d.geometry.coordinates)[0]
      })
      .attr('cy', function(d) {
        return projection(d.geometry.coordinates)[1]
      })
      .attr('fill', function(d, i) {
        return color(d.properties.institution_gender_index);
      })
      .attr('stroke-width', 0)
      .attr('class', 'institute-circle')
      .on('click', showInstituteData)
      .append("svg:title") // TITLE APPENDED HERE
      .text(function(institut) {
        return institut.properties.name + "\n" + (Math.round(institut.properties.institution_gender_index * 100) / 100);
      });


    var zoom = d3.zoom();

    map.call(d3.zoom()
      .extent([
        [0, 0],
        [width, height]
      ])
      .scaleExtent([1, 50])
      .on("zoom", zoomed));

    function zoomed() {
      deutschland.attr("transform", d3.event.transform);
      institute.attr("transform", d3.event.transform);

      var scaleFactor = d3.event.transform.k;

      institute.selectAll('circle')
        .attr('r', function(d, i) {
          return radius(d.properties.total_projects_count) / (scaleFactor * 0.8);
        })
      // .attr('stroke-width',1/scaleFactor);

    }
  </script>
</body>

</html>
